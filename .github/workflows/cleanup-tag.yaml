name: Cleanup Old Tags and Releases

on:
  schedule:
    - cron: '0 0 * * 0' # Runs weekly on Sunday at midnight
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.MY_GITHUB_TOKEN }}

    - name: Get all tags
      id: get_tags
      run: |
        git fetch --tags
        tags=$(git tag --sort=-creatordate)
        echo "::set-output name=tags::$tags"

    - name: Delete old tags and releases
      run: |
        tags_array=(${{ steps.get_tags.outputs.tags }})
        keep_count=0
        if [ ${#tags_array[@]} -gt $keep_count ]; then
          for tag in "${tags_array[@]:$keep_count}"; do
            echo "Deleting tag: $tag"
            git push --delete origin $tag

            release_id=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              https://api.github.com/repos/${{ github.repository }}/releases/tags/$tag | jq -r '.id')

            if [ "$release_id" != "null" ]; then
              echo "Deleting release: $release_id"
              curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                https://api.github.com/repos/${{ github.repository }}/releases/$release_id
            fi
          done
        else
          echo "No tags to delete"
        fi
